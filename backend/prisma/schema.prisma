generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// USER & AUTHENTICATION
// =====================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Hashed password
  name              String
  role              UserRole  @default(STUDENT)
  phone             String?
  address           String?
  bio               String?
  preferredLanguage String?   @default("en")
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete

  // Role-specific profiles (one-to-one)
  schoolProfile  School?
  teacherProfile Teacher?
  studentProfile Student?

  // Notifications sent to this user
  notifications Notification[]

  // Exercises created by this user
  createdExercises Exercise[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN           // System administrator (owns the school)
  TEACHER         // Instructor/trainer
  STUDENT         // Learner/participant
}

// =====================================================
// SCHOOL (Previously Client)
// =====================================================

model School {
  id               String   @id @default(cuid())
  name             String
  email            String   @unique
  company          String?
  description      String?
  logo             String?  // URL to logo image
  subscriptionPlan SubscriptionPlan @default(BASIC)
  billingEmail     String?
  billingAddress   Json?    // { street, city, state, zip, country }
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime? // Soft delete

  // Italian tax/billing information
  vatNumber        String?  // Partita IVA
  fiscalCode       String?  // Codice Fiscale
  sdiCode          String?  // Codice Destinatario SDI (7 chars)
  pecEmail         String?  // PEC email for electronic invoicing
  legalAddress     Json?    // Sede Legale { street, city, province, cap, country }
  reaNumber        String?  // Numero REA
  shareCapital     Decimal? @db.Decimal(12, 2) // Capitale Sociale

  // Owner user account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  teachers       Teacher[]
  students       Student[]
  courses        Course[]
  payments       Payment[]
  invoices       Invoice[]
  ssoConfig      SsoConfig?
  apiKeys        ApiKey[]
  videoLibraries VideoLibrary[]
  exercises      Exercise[]

  @@index([email])
  @@index([userId])
  @@index([vatNumber])
  @@map("schools")
}

enum SubscriptionPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

// =====================================================
// TEACHER (Previously Trainer)
// =====================================================

model Teacher {
  id         String   @id @default(cuid())
  bio        String?
  expertise  String[] // Areas of expertise
  hourlyRate Decimal? @db.Decimal(10, 2)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  deletedAt  DateTime? // Soft delete

  // User account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // School affiliation
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Relations
  lessons             Lesson[]
  feedback            Feedback[]
  questions           Question[]
  courseTeachers      CourseTeacher[]
  availability        TeacherAvailability[]
  substitutionsFrom   Substitution[] @relation("OriginalTeacher")
  substitutionsTo     Substitution[] @relation("SubstituteTeacher")
  payrollRecords      TeacherPayroll[]

  @@index([userId])
  @@index([schoolId])
  @@map("teachers")
}

// =====================================================
// STUDENT (Previously Participant)
// =====================================================

model Student {
  id            String           @id @default(cuid())
  languageLevel LanguageLevel    @default(B1)
  bio           String?
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime? // Soft delete

  // User account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // School affiliation
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Relations
  enrollments      Enrollment[]
  attendance       Attendance[]
  progress         Progress[]
  feedback         Feedback[]
  topicVotes       TopicVote[]
  assessments      Assessment[]
  certificates     Certificate[]
  chatSessions     ChatSession[]
  speakingSessions SpeakingSession[]
  videoProgress    VideoProgress[]
  exerciseAttempts ExerciseAttempt[]

  @@index([userId])
  @@index([schoolId])
  @@map("students")
}

enum LanguageLevel {
  A1
  A2
  B1
  B2
  C1
  C2
}

// =====================================================
// COURSE (Previously Roundtable)
// =====================================================

model Course {
  id              String       @id @default(cuid())
  name            String
  description     String?
  status          CourseStatus @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  maxStudents     Int          @default(10)
  price           Decimal?     @db.Decimal(10, 2)
  currency        String       @default("EUR")
  thumbnailUrl    String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime? // Soft delete

  // School that owns this course
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Relations
  enrollments    Enrollment[]
  lessons        Lesson[]
  modules        Module[]
  topicVotes     TopicVote[]
  progress       Progress[]
  courseTeachers CourseTeacher[]
  certificates   Certificate[]

  @@index([schoolId])
  @@index([status])
  @@map("courses")
}

enum CourseStatus {
  DRAFT          // Course being set up
  TOPIC_VOTING   // Students voting on topics
  SCHEDULED      // Course scheduled to start
  IN_PROGRESS    // Course actively running
  COMPLETED      // Course finished
  CANCELLED      // Course cancelled
  ARCHIVED       // Course archived
}

// Many-to-many: Course <-> Teacher
model CourseTeacher {
  id        String   @id @default(cuid())
  isPrimary Boolean  @default(false) // Primary teacher for the course
  createdAt DateTime @default(now())

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([courseId, teacherId])
  @@map("course_teachers")
}

// =====================================================
// MODULE (Topic/Chapter within a Course)
// =====================================================

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  orderIndex  Int      @default(0)
  isSelected  Boolean  @default(false) // For topic voting
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Relations
  votes   TopicVote[]
  lessons Lesson[]

  @@index([courseId])
  @@map("modules")
}

// =====================================================
// LESSON (Previously Session)
// =====================================================

model Lesson {
  id           String       @id @default(cuid())
  lessonNumber Int          // Sequence number within course
  title        String?
  description  String?
  scheduledAt  DateTime
  duration     Int          @default(60) // Duration in minutes
  status       LessonStatus @default(SCHEDULED)
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime? // Soft delete

  // Video Conferencing Integration
  meetingProvider   MeetingProvider? // Which platform (Zoom, Meet, Teams)
  meetingId         String?          // External meeting ID
  meetingLink       String?          // Join link for students
  meetingHostUrl    String?          // Host/start link for teacher
  meetingPassword   String?          // Meeting password if required
  meetingRecordingUrl String?        // Recording link after lesson

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // Optional: specific module/topic for this lesson
  moduleId String?
  module   Module? @relation(fields: [moduleId], references: [id])

  // Assigned teacher
  teacherId String?
  teacher   Teacher? @relation(fields: [teacherId], references: [id])

  // Substitution tracking
  originalTeacherId String?
  substitution      Substitution?

  // Relations
  questions     Question[]
  feedback      Feedback[]
  attendance    Attendance[]
  materials     Material[]
  notifications Notification[]
  videoContents VideoContent[]
  exercises     Exercise[]

  @@unique([courseId, lessonNumber])
  @@index([scheduledAt])
  @@index([teacherId])
  @@index([meetingProvider])
  @@map("lessons")
}

enum MeetingProvider {
  ZOOM
  GOOGLE_MEET
  MICROSOFT_TEAMS
  CUSTOM // For custom/manual meeting links
}

enum LessonStatus {
  SCHEDULED
  REMINDER_SENT
  QUESTIONS_REQUESTED
  QUESTIONS_READY
  IN_PROGRESS
  COMPLETED
  FEEDBACK_PENDING
  FEEDBACK_SENT
  CANCELLED
}

// =====================================================
// ENROLLMENT
// =====================================================

model Enrollment {
  id            String           @id @default(cuid())
  enrolledAt    DateTime         @default(now())
  status        EnrollmentStatus @default(PENDING)
  paymentStatus PaymentStatus    @default(PENDING)
  amountDue     Decimal?         @db.Decimal(10, 2)
  amountPaid    Decimal?         @db.Decimal(10, 2)
  notes         String?
  completedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  payments        Payment[]
  installmentPlan InstallmentPlan?

  @@unique([studentId, courseId])
  @@index([status])
  @@index([paymentStatus])
  @@map("enrollments")
}

enum EnrollmentStatus {
  PENDING    // Awaiting confirmation
  ACTIVE     // Currently enrolled
  COMPLETED  // Finished the course
  DROPPED    // Dropped out
  SUSPENDED  // Temporarily suspended
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

// =====================================================
// ATTENDANCE
// =====================================================

model Attendance {
  id        String    @id @default(cuid())
  attended  Boolean   @default(false)
  joinedAt  DateTime?
  leftAt    DateTime?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([lessonId, studentId])
  @@map("attendance")
}

// =====================================================
// PROGRESS
// =====================================================

model Progress {
  id               String    @id @default(cuid())
  completedLessons Int       @default(0)
  totalLessons     Int       @default(0)
  percentage       Decimal   @default(0) @db.Decimal(5, 2)
  grade            String?   // A, B, C, D, F or custom grading
  averageScore     Decimal?  @db.Decimal(5, 2)
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("progress")
}

// =====================================================
// TOPIC VOTING
// =====================================================

model TopicVote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, moduleId])
  @@map("topic_votes")
}

// =====================================================
// QUESTIONS (Pre-lesson questions from teachers)
// =====================================================

model Question {
  id          String         @id @default(cuid())
  question    String
  status      QuestionStatus @default(PENDING)
  reviewNotes String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Teacher who submitted the question
  teacherId String?
  teacher   Teacher? @relation(fields: [teacherId], references: [id])

  @@index([lessonId])
  @@index([status])
  @@map("questions")
}

enum QuestionStatus {
  PENDING
  APPROVED
  NEEDS_REVISION
  REJECTED
}

// =====================================================
// FEEDBACK (Teacher feedback for students)
// =====================================================

model Feedback {
  id          String         @id @default(cuid())
  content     String
  score       Int?           // 1-10 or 1-100 based on grading system
  status      FeedbackStatus @default(PENDING)
  reviewNotes String?
  sentAt      DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([lessonId, studentId])
  @@map("feedback")
}

enum FeedbackStatus {
  PENDING
  APPROVED
  NEEDS_REVISION
  SENT
  REJECTED
}

// =====================================================
// MATERIALS (Lesson resources)
// =====================================================

model Material {
  id          String       @id @default(cuid())
  title       String
  description String?
  type        MaterialType
  url         String       // File URL or external link
  fileSize    Int?         // Size in bytes
  mimeType    String?
  orderIndex  Int          @default(0)
  uploadedAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("materials")
}

enum MaterialType {
  PDF
  VIDEO
  LINK
  IMAGE
  DOCUMENT
  AUDIO
  OTHER
}

// =====================================================
// PAYMENTS
// =====================================================

model Payment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("EUR")
  status        PaymentStatus @default(PENDING)
  paymentMethod String?       // card, bank_transfer, cash, etc.
  transactionId String?       // External payment provider transaction ID
  notes         String?
  paidAt        DateTime?
  dueDate       DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Can be linked to enrollment or directly to school
  enrollmentId String?
  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id])

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id])

  // Link to invoice
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  // If payment is for an installment
  installments Installment[]

  @@index([status])
  @@index([invoiceId])
  @@map("payments")
}

// =====================================================
// NOTIFICATIONS
// =====================================================

model Notification {
  id          String             @id @default(cuid())
  type        NotificationType
  subject     String
  content     String
  status      NotificationStatus @default(PENDING)
  scheduledAt DateTime?
  sentAt      DateTime?
  readAt      DateTime?
  metadata    Json?              // Additional data for the notification
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Recipient
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional: related lesson
  lessonId String?
  lesson   Lesson? @relation(fields: [lessonId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
  @@map("notifications")
}

enum NotificationType {
  TEACHER_REMINDER
  QUESTIONS_REQUEST
  FEEDBACK_REQUEST
  ENROLLMENT_CONFIRMED
  LESSON_REMINDER
  VOTING_INVITE
  PAYMENT_REMINDER
  PAYMENT_RECEIVED
  COURSE_UPDATE
  ASSESSMENT_ASSIGNED
  GENERAL
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
  READ
}

// =====================================================
// REFRESH TOKENS (for JWT refresh token rotation)
// =====================================================

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// =====================================================
// TEACHER AVAILABILITY & SCHEDULING
// =====================================================

model TeacherAvailability {
  id          String              @id @default(cuid())
  dayOfWeek   Int                 // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime   String              // HH:MM format (e.g., "09:00")
  endTime     String              // HH:MM format (e.g., "17:00")
  isRecurring Boolean             @default(true) // Weekly recurring
  specificDate DateTime?          // For non-recurring availability
  status      AvailabilityStatus  @default(AVAILABLE)
  notes       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([dayOfWeek])
  @@map("teacher_availability")
}

enum AvailabilityStatus {
  AVAILABLE
  BUSY
  TENTATIVE
  VACATION
  SICK_LEAVE
}

model Substitution {
  id              String             @id @default(cuid())
  reason          SubstitutionReason
  notes           String?
  status          SubstitutionStatus @default(PENDING)
  requestedAt     DateTime           @default(now())
  confirmedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // The lesson being substituted
  lessonId String @unique
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Original teacher who can't attend
  originalTeacherId String
  originalTeacher   Teacher @relation("OriginalTeacher", fields: [originalTeacherId], references: [id])

  // Substitute teacher (null until assigned)
  substituteTeacherId String?
  substituteTeacher   Teacher? @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [id])

  @@index([status])
  @@map("substitutions")
}

enum SubstitutionReason {
  SICK_LEAVE
  VACATION
  EMERGENCY
  SCHEDULING_CONFLICT
  OTHER
}

enum SubstitutionStatus {
  PENDING           // Needs a substitute
  SUBSTITUTE_FOUND  // Substitute assigned
  CONFIRMED         // Substitute confirmed
  CANCELLED         // Substitution cancelled
  COMPLETED         // Lesson completed with substitute
}

// =====================================================
// TEACHER PAYROLL
// =====================================================

model TeacherPayroll {
  id              String        @id @default(cuid())
  periodStart     DateTime      // Start of pay period
  periodEnd       DateTime      // End of pay period
  totalHours      Decimal       @db.Decimal(10, 2)
  hourlyRate      Decimal       @db.Decimal(10, 2)
  grossAmount     Decimal       @db.Decimal(10, 2)
  deductions      Decimal       @default(0) @db.Decimal(10, 2)
  netAmount       Decimal       @db.Decimal(10, 2)
  currency        String        @default("EUR")
  status          PayrollStatus @default(PENDING)
  lessonsCount    Int           @default(0)
  bonuses         Decimal       @default(0) @db.Decimal(10, 2)
  bonusNotes      String?
  paidAt          DateTime?
  paymentMethod   String?       // bank_transfer, cash, etc.
  paymentReference String?      // Transaction ID or reference
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Link to invoice if generated
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([teacherId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("teacher_payroll")
}

enum PayrollStatus {
  PENDING     // Being calculated
  APPROVED    // Approved for payment
  PAID        // Payment completed
  CANCELLED   // Cancelled
}

// =====================================================
// INSTALLMENT PLANS
// =====================================================

model InstallmentPlan {
  id                String              @id @default(cuid())
  totalAmount       Decimal             @db.Decimal(10, 2)
  numberOfInstallments Int
  installmentAmount Decimal             @db.Decimal(10, 2)
  currency          String              @default("EUR")
  startDate         DateTime
  frequency         InstallmentFrequency @default(MONTHLY)
  status            InstallmentPlanStatus @default(ACTIVE)
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Link to enrollment
  enrollmentId String @unique
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  // Individual installments
  installments Installment[]

  @@map("installment_plans")
}

enum InstallmentFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

enum InstallmentPlanStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

model Installment {
  id          String            @id @default(cuid())
  number      Int               // Installment number (1, 2, 3...)
  amount      Decimal           @db.Decimal(10, 2)
  dueDate     DateTime
  status      InstallmentStatus @default(PENDING)
  paidAt      DateTime?
  paidAmount  Decimal?          @db.Decimal(10, 2)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  planId String
  plan   InstallmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Link to payment record
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])

  @@unique([planId, number])
  @@index([dueDate])
  @@index([status])
  @@map("installments")
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
}

// =====================================================
// ITALIAN ELECTRONIC INVOICING (Fattura Elettronica)
// =====================================================

model Invoice {
  id                  String        @id @default(cuid())
  invoiceNumber       String        @unique // Progressive number
  invoiceDate         DateTime      @default(now())
  dueDate             DateTime?

  // Amounts
  subtotal            Decimal       @db.Decimal(10, 2)
  vatRate             Decimal       @default(22) @db.Decimal(5, 2) // Italian VAT 22%
  vatAmount           Decimal       @db.Decimal(10, 2)
  totalAmount         Decimal       @db.Decimal(10, 2)
  currency            String        @default("EUR")

  // Status
  status              InvoiceStatus @default(DRAFT)
  paidAt              DateTime?

  // Italian Electronic Invoice (FatturaPA) fields
  isElectronic        Boolean       @default(false) // Is Fattura Elettronica
  sdiStatus           SdiStatus?    // SDI transmission status
  sdiIdentifier       String?       // SDI file identifier
  sdiTransmissionDate DateTime?     // When sent to SDI
  sdiResponseDate     DateTime?     // When SDI responded
  sdiErrorMessage     String?       // SDI error if rejected

  // Recipient details (for electronic invoice)
  recipientType       RecipientType? // PA, B2B, B2C
  recipientCodiceSDI  String?       // 7-char SDI code (Codice Destinatario)
  recipientPEC        String?       // PEC email if no SDI code
  recipientVatNumber  String?       // Partita IVA
  recipientFiscalCode String?       // Codice Fiscale

  // Document type
  documentType        FatturaType   @default(TD01) // Tipo Documento

  // Payment terms
  paymentTerms        String?       // e.g., "30 days net"
  paymentMethod       PaymentMethodCode? // Codice Modalità Pagamento

  // Line items stored as JSON
  lineItems           Json          // Array of line items

  // PDF and XML storage
  pdfUrl              String?       // Generated PDF invoice
  xmlUrl              String?       // FatturaPA XML file

  notes               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id])

  payments        Payment[]
  payrollRecords  TeacherPayroll[]

  @@index([invoiceNumber])
  @@index([status])
  @@index([schoolId])
  @@index([sdiStatus])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
  CREDITED
}

enum SdiStatus {
  NOT_SENT         // Not yet sent to SDI
  SENDING          // Transmission in progress
  DELIVERED        // Delivered to recipient
  NOT_DELIVERED    // Failed to deliver
  ACCEPTED         // Accepted by PA (for public administration)
  REJECTED         // Rejected by SDI
  DECODING_ERROR   // File format error
  FILE_REJECTED    // File rejected after delivery
}

enum RecipientType {
  PA    // Pubblica Amministrazione
  B2B   // Business to Business
  B2C   // Business to Consumer
}

enum FatturaType {
  TD01  // Fattura
  TD02  // Acconto/Anticipo su fattura
  TD03  // Acconto/Anticipo su parcella
  TD04  // Nota di Credito
  TD05  // Nota di Debito
  TD06  // Parcella
  TD16  // Integrazione fattura reverse charge interno
  TD17  // Integrazione/autofattura per acquisto servizi dall'estero
  TD18  // Integrazione per acquisto di beni intracomunitari
  TD19  // Integrazione/autofattura per acquisto di beni ex art.17 c.2 DPR 633/72
  TD20  // Autofattura per regolarizzazione e integrazione delle fatture
  TD21  // Autofattura per splafonamento
  TD22  // Estrazione beni da Deposito IVA
  TD23  // Estrazione beni da Deposito IVA con versamento dell'IVA
  TD24  // Fattura differita di cui all'art. 21, comma 4, lett. a)
  TD25  // Fattura differita di cui all'art. 21, comma 4, terzo periodo lett. b)
  TD26  // Cessione di beni ammortizzabili e per passaggi interni
  TD27  // Fattura per autoconsumo o per cessioni gratuite senza rivalsa
}

enum PaymentMethodCode {
  MP01  // Contanti
  MP02  // Assegno
  MP03  // Assegno circolare
  MP04  // Contanti presso Tesoreria
  MP05  // Bonifico
  MP06  // Vaglia cambiario
  MP07  // Bollettino bancario
  MP08  // Carta di pagamento
  MP09  // RID
  MP10  // RID utenze
  MP11  // RID veloce
  MP12  // RIBA
  MP13  // MAV
  MP14  // Quietanza erario
  MP15  // Giroconto su conti di contabilità speciale
  MP16  // Domiciliazione bancaria
  MP17  // Domiciliazione postale
  MP18  // Bollettino di c/c postale
  MP19  // SEPA Direct Debit
  MP20  // SEPA Direct Debit CORE
  MP21  // SEPA Direct Debit B2B
  MP22  // Trattenuta su somme già riscosse
  MP23  // PagoPA
}

// =====================================================
// ASSESSMENT & CERTIFICATION
// =====================================================

model Assessment {
  id             String           @id @default(cuid())
  studentId      String
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  language       String
  type           AssessmentType   @default(PLACEMENT)
  score          Int?
  cefrLevel      String?          // A1, A2, B1, B2, C1, C2
  status         AssessmentStatus @default(IN_PROGRESS)
  answers        Json?            // Array of {questionId, answer, isCorrect}
  targetLevel    String           @default("B1") // Adaptive state persisted across API calls
  questionsLimit Int              @default(40)   // Configurable test length
  startedAt      DateTime?
  completedAt    DateTime?

  // Assignment & security fields
  assignedById   String?          // userId of admin who assigned (null = self-started)
  assignedAt     DateTime?        // when assigned
  timeLimitMin   Int?             // minutes allowed (null = unlimited for self-started)
  expiresAt      DateTime?        // set when student starts: startedAt + timeLimitMin
  violations     Json?            // [{type, timestamp, details}] — tab switches, copy attempts, etc.

  @@index([studentId])
  @@index([language])
  @@map("assessments")
}

model AssessmentQuestion {
  id           String              @id @default(cuid())
  language     String
  cefrLevel    String              // A1, A2, B1, B2, C1, C2
  questionType AssessmentQuestionType
  questionText String
  options      Json?               // For multiple choice: [{label, value}]
  correctAnswer String
  passage      String?             // Reading comprehension text
  passageTitle String?             // Optional passage header
  audioUrl     String?
  imageUrl     String?
  points       Int                 @default(1)
  orderIndex   Int                 @default(0)
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([language, cefrLevel])
  @@index([isActive])
  @@map("assessment_questions")
}

model Certificate {
  id                String   @id @default(cuid())
  studentId         String
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId          String?
  course            Course?  @relation(fields: [courseId], references: [id])
  assessmentId      String?
  cefrLevel         String
  language          String
  certificateNumber String   @unique
  issuedAt          DateTime @default(now())
  pdfUrl            String?
  validUntil        DateTime?
  metadata          Json?    // Additional certificate data

  @@index([studentId])
  @@index([certificateNumber])
  @@map("certificates")
}

enum AssessmentType {
  PLACEMENT
  PROGRESS
  FINAL
}

enum AssessmentStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum AssessmentQuestionType {
  MULTIPLE_CHOICE
  FILL_BLANK
  LISTENING
  READING
  WRITING
}

// =====================================================
// ENTERPRISE INTEGRATIONS
// =====================================================

model SsoConfig {
  id          String   @id @default(cuid())
  schoolId    String   @unique
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  provider    String   // SAML, OIDC
  entityId    String
  ssoUrl      String
  certificate String   @db.Text
  isActive    Boolean  @default(true)
  metadata    Json?    // Additional provider config
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sso_configs")
}

model ApiKey {
  id          String    @id @default(cuid())
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  key         String    @unique
  keyPrefix   String    // First 8 chars for display (e.g., "maka_abc1...")
  permissions Json      // ['read:courses', 'write:enrollments', etc.]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([key])
  @@index([schoolId])
  @@map("api_keys")
}

// =====================================================
// AI FEATURES
// =====================================================

model ChatSession {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  language    String
  topic       String?
  cefrLevel   String?  // Target conversation level
  messages    Json     // Array of {role, content, timestamp}
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Speaking sessions linked to this chat
  speakingSessions SpeakingSession[]

  @@index([studentId])
  @@index([createdAt])
  @@map("chat_sessions")
}

// =====================================================
// SPEECH RECOGNITION & SPEAKING PRACTICE
// =====================================================

model SpeakingSession {
  id              String       @id @default(cuid())
  studentId       String
  student         Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  chatSessionId   String?
  chatSession     ChatSession? @relation(fields: [chatSessionId], references: [id])
  language        String
  cefrLevel       String?
  targetText      String?      // The text student should pronounce
  recognizedText  String?      // What was recognized
  accuracyScore   Int?         // 0-100
  fluencyScore    Int?         // 0-100
  feedback        Json?        // Detailed word-level feedback
  audioUrl        String?      // Stored audio recording
  duration        Int?         // Duration in seconds
  createdAt       DateTime     @default(now())

  @@index([studentId])
  @@index([chatSessionId])
  @@map("speaking_sessions")
}

// =====================================================
// VIDEO CONTENT LIBRARY
// =====================================================

model VideoLibrary {
  id          String          @id @default(cuid())
  title       String
  description String?
  coverImage  String?
  isPublished Boolean         @default(false)
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  categories  VideoCategory[]
  videos      VideoContent[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([schoolId])
  @@map("video_libraries")
}

model VideoCategory {
  id          String         @id @default(cuid())
  name        String
  description String?
  orderIndex  Int            @default(0)
  libraryId   String
  library     VideoLibrary   @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  videos      VideoContent[]

  @@index([libraryId])
  @@map("video_categories")
}

model VideoContent {
  id            String          @id @default(cuid())
  title         String
  description   String?
  url           String
  thumbnailUrl  String?
  duration      Int?            // Duration in seconds
  language      String
  cefrLevel     String?
  tags          String[]
  transcript    String?         @db.Text
  subtitlesUrl  String?
  isPublished   Boolean         @default(false)
  orderIndex    Int             @default(0)
  viewCount     Int             @default(0)
  libraryId     String
  library       VideoLibrary    @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  categoryId    String?
  category      VideoCategory?  @relation(fields: [categoryId], references: [id])
  lessonId      String?
  lesson        Lesson?         @relation(fields: [lessonId], references: [id])
  watchProgress VideoProgress[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([libraryId])
  @@index([categoryId])
  @@index([cefrLevel])
  @@map("video_contents")
}

model VideoProgress {
  id             String       @id @default(cuid())
  videoId        String
  video          VideoContent @relation(fields: [videoId], references: [id], onDelete: Cascade)
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  watchedSeconds Int          @default(0)
  totalSeconds   Int          @default(0)
  percentage     Int          @default(0)
  isCompleted    Boolean      @default(false)
  lastWatchedAt  DateTime     @default(now())
  completedAt    DateTime?

  @@unique([videoId, studentId])
  @@index([studentId])
  @@map("video_progress")
}

// =====================================================
// INTERACTIVE EXERCISES
// =====================================================

model Exercise {
  id           String           @id @default(cuid())
  title        String
  description  String?
  type         ExerciseType
  language     String
  cefrLevel    String?
  instructions String?
  timeLimit    Int?             // Time limit in seconds
  passingScore Int              @default(70)
  config       Json             // Exercise-type specific configuration
  isPublished  Boolean          @default(false)
  createdById  String
  createdBy    User             @relation(fields: [createdById], references: [id])
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  lessonId     String?
  lesson       Lesson?          @relation(fields: [lessonId], references: [id])
  items        ExerciseItem[]
  attempts     ExerciseAttempt[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([schoolId])
  @@index([cefrLevel])
  @@index([type])
  @@map("exercises")
}

enum ExerciseType {
  DRAG_DROP
  MATCHING
  FILL_BLANKS
  LISTENING
  REORDER
  MULTIPLE_CHOICE
  TRUE_FALSE
}

model ExerciseItem {
  id            String   @id @default(cuid())
  exerciseId    String
  exercise      Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  orderIndex    Int      @default(0)
  questionText  String?
  content       Json     // Item-specific content (options, pairs, blanks, etc.)
  correctAnswer Json     // Correct answer(s)
  points        Int      @default(1)
  hint          String?
  explanation   String?
  audioUrl      String?
  imageUrl      String?

  @@index([exerciseId])
  @@map("exercise_items")
}

model ExerciseAttempt {
  id          String                @id @default(cuid())
  exerciseId  String
  exercise    Exercise              @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  status      ExerciseAttemptStatus @default(IN_PROGRESS)
  score       Int?
  maxScore    Int?
  percentage  Int?
  answers     Json?                 // Array of {itemId, answer, isCorrect, points}
  startedAt   DateTime              @default(now())
  completedAt DateTime?
  timeSpent   Int?                  // Time spent in seconds

  @@index([studentId])
  @@index([exerciseId])
  @@map("exercise_attempts")
}

enum ExerciseAttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}
